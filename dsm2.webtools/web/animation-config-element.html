<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="description" content="Demo of simple element">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="bower_components/file-saver/FileSaver.min.js" type="text/javascript"></script>
    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/app-storage/app-localstorage/app-localstorage-document.html">
    <link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="bower_components/iron-icons/editor-icons.html">
    <link rel="import" href="bower_components/iron-location/iron-location.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="bower_components/paper-input/paper-input.html">
    <link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">
    <link rel="import" href="bower_components/paper-material/paper-material.html">
</head>

<body>
    <dom-module id="animation-config-element">
        <style type="text/css">
            #configSelector {
                width: 100%;
            }
        </style>
    <template>
    <input type="file" id="uploadFileInputElement" multiple accept="*/*" style="display: none" onchange="this.parentElement.uploadConfig(this.files)" />
	<iron-ajax id="animConfigRequest" auto url="dsm2animconfig"
			handle-as="json"
			on-response="handleServerConfigResponse">
	</iron-ajax>
	<paper-dropdown-menu id="configSelector" label="Select Config"  style="width: 100%" >
		<paper-listbox id="configListBox" selected="{{configName}}" class="dropdown-content" attr-for-selected="value" on-tap="onSelectConfig" style="width: 100%;">
		<template is="dom-repeat" items="[[configs]]">
			<paper-item value="[[item.name]]">[[item.name]]</paper-item>
		</template>
        </paper-listbox>
        </paper-dropdown-menu>
        <iron-location id="location" dwell-time="1000"></iron-location>
        <paper-material elevation="3">
            <div>
                <div>
                    <paper-input id="configNameInput" label="Config Name" value="[[configName]]"></paper-input>
                    <paper-icon-button alt="Save" icon="icons:save" id="save" on-tap="saveConfig"></paper-icon-button>
                    <paper-icon-button alt="Delete" icon="icons:delete" id="load" on-tap="deleteConfig"></paper-icon-button>
                    <paper-icon-button alt="Download" icon="icons:file-download" id="download" on-tap="downloadConfig"></paper-icon-button>
                    <paper-icon-button alt="Upload" icon="icons:file-upload" id="upload" on-tap="openUploadDialog"></paper-icon-button>
                </div>
                <app-localstorage-document key="configs" data="{{configs}}"></app-localstorage-document>
            </div>
        </paper-material>
        </template>
        <script type="text/javascript">
            'use strict';
            Polymer({
                is: 'animation-config-element',

                properties: {
                    configSelected: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    configs: {
                        type: Object,
                        notify: true,
                        observer: "_configsChanged"
                    }
                },

                ready: function() {
                    var mc = this;
                    var locationElement = this.$.location;
                    if (locationElement) {
                        locationElement.addEventListener('hash-changed',
                            function(e) {
                                mc.loadConfiguration(e.detail.value);
                            });
                    }
                },

                _configsChanged: function() {
                    var mc = this;
                    var locationElement = this.$.location;
                    if (locationElement) {
                        if (this.configs && mc.configs.length > 0) {
                            locationElement.hash.length > 0 ? mc.loadConfiguration(locationElement.hash) : mc.loadConfiguration(mc.configs[0].name);
                        }
                    } else {
                        if (this.configs && mc.configs.length > 0) {
                            mc.loadConfiguration(mc.configs[0].name)
                        }
                    }
                },

                loadConfiguration: function(name) {
                    var mc = this;
                    if (!mc.configs) return;
                    for (var i = 0; i < mc.configs.length; i++) {
                        var config = mc.configs[i];
                        if (config.name == name) {
                            mc.setConfiguration(config);
                            mc.configName = config.name;
                            return config.name;
                        }
                    }
                },

                handleServerConfigResponse: function(e) {
                    this.mergeConfiguration(e.detail.response);
                },

                mergeConfiguration: function(configs) {
                    var mc = this;
                    if (location.hostname != 'localhost' && location.hostname != '127.0.0.1') {
                        mc.configs = null;
                    }
                    if (!mc.configs) {
                        this.configs = configs;
                    } else {
                        for (var i = 0; i < configs.length; i++) {
                            var xconfig = configs[i];
                            mc.addOrUpdateConfig(xconfig);
                        }
                    }
                    mc.notifyPath('configs');
                },

                setConfiguration: function(config) {
                    this.configSelected = this.copyProperties({}, config); //Object.assign({},config); // make a copy
                    this.configName = this.configSelected.name;
                    this.fire('config-selected', this.configSelected);
                },

                onSelectConfig: function(e) {
                    this.$.location.hash = e.target.value;
                },

                saveConfig: function() {
                    var mc = document.getElementById('mainContext');
                    var configInputElement = this.$.configNameInput
                    var config = this.copyProperties(this.copyProperties({},this.configSelected),{name: configInputElement.value});
                    this.addOrUpdateConfig(config);
                    this.setConfiguration(config);
                },

                addOrUpdateConfig: function(config, override) {
                    var mc = this;
                    override = typeof override != 'undefined' ? override : true;
                    for (var i = 0; i < mc.configs.length; i++) {
                        var xconfig = mc.configs[i];
                        if (xconfig.name == config.name) {
                            if (override) {
                                xconfig = this.copyProperties(xconfig, config);
                            }
                            return;
                        }
                    }
                    mc.push('configs', config);
                },

                deleteConfig: function() {
                    var mc = this;
                    if (mc.configs.length == 0){
                    	return;
                    }
                    var i = 0;
                    for (i = 0; i < mc.configs.length; i++) {
                        var config = mc.configs[i]
                        if (config.name == mc.configName) {
                            break;
                        }
                    }
                    if (i >= mc.configs.length){
                    	return;
                    }
                    var configToBeDeleted = mc.configs[i].name;
                    mc.splice('configs', i, 1);
                    if (mc.configs.length > 0){
                    	mc.setConfiguration(mc.configs[0]);
                    }
                },

                downloadConfig: function() {
                    var mc = this;
                    var i = 0;
                    for (i = 0; i < mc.configs.length; i++) {
                        var config = mc.configs[i]
                        if (config.name == mc.configName) {
                            break;
                        }
                    }
                    saveAs(new Blob([JSON.stringify(config)], {
                        type: "text/plain;"
                    }), config.name + ".animconfig");

                },

                openUploadDialog: function() {
                   this.$.uploadFileInputElement.click();
                },
                
                uploadConfig: function(files) {
                    var mc = this;
                    var r = new FileReader();
                    r.onloadend = function(e) {
                        if (e.target.readyState == FileReader.DONE) {
                            var config = JSON.parse(e.target.result);
                            mc.addOrUpdateConfig(config);
                            mc.setConfiguration(config);
                        }
                    }
                    for (var i = 0; i < files.length; i++) {
                        r.readAsText(files[i]);
                    }
                },

                /* FIXME: This function is because Object.assign is not available in IE */
                copyProperties: function(target, source) {
                    var nms = Object.getOwnPropertyNames(source);
                    for (var i = 0; i < nms.length; i++) {
                		var key = nms[i];
                		target[key] = source[key];
                    }
                    return target;
                }
            });
        </script>
    </dom-module>
</body>

</html>
